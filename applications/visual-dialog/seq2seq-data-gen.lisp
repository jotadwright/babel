(ql:quickload :visual-dialog)
(in-package :visual-dialog)

(defparameter *clevr-data-path*
  (parse-namestring "/Users/jensnevens/corpora/CLEVR-v1.0/"))

(defparameter *mnist-data-path*
  (parse-namestring "/Users/jensnevens/corpora/MNIST-Dialog/"))

(defparameter *clevr-val-world*
  (make-instance 'world
                 :entries '((:dataset .  :clevr)
                            (:datasplit . :val)
                            (:mode . :symbolic))))

(defparameter *mnist-val-world*
  (make-instance 'world
                 :entries '((:dataset . :mnist)
                            (:datasplit . :val)
                            (:mode . :symbolic))))

(activate-monitor trace-fcg)

(comprehend-dialogs 0 0 *mnist-val-world*)



#|
(add-element
 `((div)
   ,(irl-program->svg 
     (preprocess-program
      (read-from-string
       (mkstr
        '((CLEVR-DIALOG-GRAMMAR:FIND-IN-CONTEXT #:?TARGET-363312 #:?SOURCE-154961 #:?TARGET-363280)
          (CLEVR-DIALOG-GRAMMAR:UNIQUE #:?ONETARGET-9923 #:?TARGET-363312)
          (UTILS:BIND CLEVR-DIALOG-GRAMMAR:MATERIAL-CATEGORY #:?MATERIAL-3053 CLEVR-DIALOG-GRAMMAR:METAL)
          (CLEVR-DIALOG-GRAMMAR:FILTER-BY-ATTRIBUTE #:?TARGET-362737 #:?SOURCE-154718 #:?SCENE-407320 #:?OBJECT-94042)
          (CLEVR-DIALOG-GRAMMAR:COUNT-OBJECTS #:?COUNT-79204 #:?TARGET-362461)
          (UTILS:BIND CLEVR-DIALOG-GRAMMAR:SHAPE-CATEGORY #:?OBJECT-94097 CLEVR-DIALOG-GRAMMAR:THING)
          (UTILS:BIND CLEVR-DIALOG-GRAMMAR:ATTRIBUTE-CATEGORY #:?ATTRIBUTE-155040 FCG:SIZE)
          (UTILS:BIND CLEVR-DIALOG-GRAMMAR:SHAPE-CATEGORY #:?OBJECT-94042 CLEVR-DIALOG-GRAMMAR:THING)
          (CLEVR-DIALOG-GRAMMAR:FILTER-BY-ATTRIBUTE #:?TARGET-362943 #:?SOURCE-154961 #:?SCENE-407556 #:?OBJECT-94097)
          (CLEVR-DIALOG-GRAMMAR:SET-DIFF #:?SOURCE-154596 #:?TARGET-362943 #:?TARGET-363280 #:?SCENE-406661)
          (CLEVR-DIALOG-GRAMMAR:FILTER-BY-ATTRIBUTE #:?TARGET-363280 #:?TARGET-362737 #:?SCENE-407925 #:?MATERIAL-3053)
          (CLEVR-DIALOG-GRAMMAR:FILTER-BY-ATTRIBUTE #:?TARGET-362461 #:?SOURCE-154596 #:?SCENE-407014 #:?SPEC-ATTR-19793)
          (CLEVR-DIALOG-GRAMMAR:QUERY #:?SPEC-ATTR-19793 #:?ONETARGET-9923 #:?SCENE-407014 #:?ATTRIBUTE-155040)
          (CLEVR-DIALOG-GRAMMAR:SEGMENT-SCENE #:?SOURCE-154961 #:?SCENE-407760))))))))

(clevr-meaning->rpn
 '((CLEVR-DIALOG-GRAMMAR:FIND-IN-CONTEXT #:?TARGET-363312 #:?SOURCE-154961 #:?TARGET-363280)
   (CLEVR-DIALOG-GRAMMAR:UNIQUE #:?ONETARGET-9923 #:?TARGET-363312)
   (UTILS:BIND CLEVR-DIALOG-GRAMMAR:MATERIAL-CATEGORY #:?MATERIAL-3053 CLEVR-DIALOG-GRAMMAR:METAL)
   (CLEVR-DIALOG-GRAMMAR:FILTER-BY-ATTRIBUTE #:?TARGET-362737 #:?SOURCE-154718 #:?SCENE-407320 #:?OBJECT-94042)
   (CLEVR-DIALOG-GRAMMAR:COUNT-OBJECTS #:?COUNT-79204 #:?TARGET-362461)
   (UTILS:BIND CLEVR-DIALOG-GRAMMAR:SHAPE-CATEGORY #:?OBJECT-94097 CLEVR-DIALOG-GRAMMAR:THING)
   (UTILS:BIND CLEVR-DIALOG-GRAMMAR:ATTRIBUTE-CATEGORY #:?ATTRIBUTE-155040 FCG:SIZE)
   (UTILS:BIND CLEVR-DIALOG-GRAMMAR:SHAPE-CATEGORY #:?OBJECT-94042 CLEVR-DIALOG-GRAMMAR:THING)
   (CLEVR-DIALOG-GRAMMAR:FILTER-BY-ATTRIBUTE #:?TARGET-362943 #:?SOURCE-154961 #:?SCENE-407556 #:?OBJECT-94097)
   (CLEVR-DIALOG-GRAMMAR:SET-DIFF #:?SOURCE-154596 #:?TARGET-362943 #:?TARGET-363280 #:?SCENE-406661)
   (CLEVR-DIALOG-GRAMMAR:FILTER-BY-ATTRIBUTE #:?TARGET-363280 #:?TARGET-362737 #:?SCENE-407925 #:?MATERIAL-3053)
   (CLEVR-DIALOG-GRAMMAR:FILTER-BY-ATTRIBUTE #:?TARGET-362461 #:?SOURCE-154596 #:?SCENE-407014 #:?SPEC-ATTR-19793)
   (CLEVR-DIALOG-GRAMMAR:QUERY #:?SPEC-ATTR-19793 #:?ONETARGET-9923 #:?SCENE-407014 #:?ATTRIBUTE-155040)
   (CLEVR-DIALOG-GRAMMAR:SEGMENT-SCENE #:?SOURCE-154961 #:?SCENE-407760)))


;; how many X share the same size as the aforementioned metal thing
;; getMemory(0/1) filter_material[metal](1/1) segmentScene(0/1) findInContext(2/1) unique(1/1) query_size(1/1)
;; getMemory(0/1) filter_material[metal](1/1) segmentScene(0/1) setDiff(2/1)
;; filter(2/1) countObjects(1/1)
(add-element
 `((div)
   ,(irl-program->svg 
     (read-from-string
      (mkstr
       (shuffle
       '((CLEVR-DIALOG-GRAMMAR:FIND-IN-CONTEXT #:?TARGET-363312 #:?SOURCE-154961 #:?TARGET-363280)
         (CLEVR-DIALOG-GRAMMAR:UNIQUE #:?ONETARGET-9923 #:?TARGET-363312)
         (UTILS:BIND CLEVR-DIALOG-GRAMMAR:MATERIAL-CATEGORY #:?MATERIAL-3053 CLEVR-DIALOG-GRAMMAR:METAL)
         (CLEVR-DIALOG-GRAMMAR:FILTER-BY-ATTRIBUTE #:?TARGET-362737 #:?SOURCE-154718 #:?SCENE-1 #:?OBJECT-94042)
         (CLEVR-DIALOG-GRAMMAR:COUNT-OBJECTS #:?COUNT-79204 #:?TARGET-362461)
         (UTILS:BIND CLEVR-DIALOG-GRAMMAR:SHAPE-CATEGORY #:?OBJECT-94097 CLEVR-DIALOG-GRAMMAR:THING)
         (UTILS:BIND CLEVR-DIALOG-GRAMMAR:ATTRIBUTE-CATEGORY #:?ATTRIBUTE-155040 FCG:SIZE)
         (UTILS:BIND CLEVR-DIALOG-GRAMMAR:SHAPE-CATEGORY #:?OBJECT-94042 CLEVR-DIALOG-GRAMMAR:THING)
         (CLEVR-DIALOG-GRAMMAR:FILTER-BY-ATTRIBUTE #:?TARGET-362943 #:?SOURCE-154961 #:?SCENE-2 #:?OBJECT-94097)
         (CLEVR-DIALOG-GRAMMAR:SET-DIFF #:?SOURCE-154596 #:?TARGET-362943 #:?TARGET-363280 #:?SCENE-3)
         (CLEVR-DIALOG-GRAMMAR:FILTER-BY-ATTRIBUTE #:?TARGET-363280 #:?TARGET-362737 #:?SCENE-4 #:?MATERIAL-3053)
         (CLEVR-DIALOG-GRAMMAR:FILTER-BY-ATTRIBUTE #:?TARGET-362461 #:?SOURCE-154596 #:?SCENE-5 #:?SPEC-ATTR-19793)
         (CLEVR-DIALOG-GRAMMAR:QUERY #:?SPEC-ATTR-19793 #:?ONETARGET-9923 #:?SCENE-6 #:?ATTRIBUTE-155040)
         (CLEVR-DIALOG-GRAMMAR:SEGMENT-SCENE #:?SOURCE-154961 #:?SCENE-7))))))))
|#