(ql:quickload :geoquery-lsfb)
(in-package :geoquery-lsfb)

;(monitors::activate-monitor trace-fcg)

(def-fcg-constructions geoquery-lsfb--grammar
  :feature-types ((subunits set)
                  (args set)
                  (footprints set)
                  (form-args sequence)
                  (form set-of-predicates)
                  (meaning-args sequence)
                  (meaning set-of-predicates))
  :hierarchy-features (subunits)
  :diagnostics ()
  :repairs ()
  :fcg-configurations ((:parse-goal-tests :no-applicable-cxns :connected-semantic-network)
                       (:production-goal-tests :no-applicable-cxns :no-meaning-in-root :connected-structure)
                       (:node-tests :check-duplicate :restrict-nr-of-nodes :restrict-search-depth)
                       (:max-number-of-nodes . 200)
                       (:max-search-depth . 50)
                       (:render-mode . :set-of-predicates) ; set de-render mode to set-of-predicates
                       (:de-render-mode . :set-of-predicates) ; set de-render mode to set-of-predicates
                       (:shuffle-cxns-before-application . t)
                       (:draw-meaning-as-network . t)
                       (:construction-inventory-processor-mode . :heuristic-search)
                       (:node-expansion-mode . :full-expansion)
                       (:search-algorithm . :best-first)
                       (:heuristic-value-mode . :sum-heuristics-and-parent)
                       (:cxn-supplier-mode . :all-cxns)
                       (:heuristics :nr-of-applied-cxns))
  
  :visualization-configurations ((:with-search-debug-data . t)
                                 (:remove-empty-units . nil)
                                 (:show-constructional-dependencies . t)
                                 (:labeled-paths . nil)
                                 (:colored-paths . nil)
                                 (:hide-features . nil)
                                 (:hierarchy-features subunits)
                                 (:selected-hierarchy . subunits)
                                 (:select-subfeatures . nil))
  
  )

; setting handedness configuration
(defparameter *dominant-hand*
  'RH
  ;'LH
  )

;--------------------------------------------------
; Example-1: simple substitution of lexical element
;--------------------------------------------------

;(pprint (mkstr (slp::xmls->predicates (slp::read-elan "/Users/liesbetdevos/Projects/geoquery-sign/additional-examples/0_2_0.eaf"))))

(defparameter *how-long-is-the-delaware-river* '((:form . ((SLP::RIGHT-HAND-ARTICULATION ?PALM-UP-16 PALM-UP)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?RIVIERE.K-31 RIVIERE.K)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?PT-16 PT)
                                                           (SLP::LOCATION ?PT-16 MIDDLE)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?FS\:DELAWARE-16 FS\:DELAWARE)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?DS-31 DS)
                                                           (SLP::LOCATION ?DS-31 MIDDLE)
                                                           (SLP::HANDSHAPE ?DS-31 1)
                                                           (SLP::ORIENTATION ?DS-31 DOWN-OUT)
                                                           (SLP::MOVEMENT ?DS-31 IN-OUT)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?COMBIEN-16 COMBIEN)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?KILOMETRE-16 KILOMETRE)
                                                           (SLP::LEFT-HAND-ARTICULATION ?RIVIERE.K-32 RIVIERE.K)
                                                           (SLP::LEFT-HAND-ARTICULATION ?DS-32 DS)
                                                           (SLP::LOCATION ?DS-32 MIDDLE)
                                                           (SLP::HANDSHAPE ?DS-32 1)
                                                           (SLP::ORIENTATION ?DS-32 RIGHT-OUT)
                                                           (MEETS ?PALM-UP-16 ?RIVIERE.K-31)
                                                           (MEETS ?RIVIERE.K-31 ?PT-16)
                                                           (MEETS ?PT-16 ?FS\:DELAWARE-16)
                                                           (MEETS ?FS\:DELAWARE-16 ?DS-31)
                                                           (MEETS ?DS-31 ?COMBIEN-16)
                                                           (MEETS ?COMBIEN-16 ?KILOMETRE-16)
                                                           (MEETS ?PALM-UP-16 ?RIVIERE.K-32)
                                                           (SLP::COINCIDES-RELATION ?RIVIERE.K-31 ?RIVIERE.K-32 EQUALS)
                                                           (SLP::MEETS ?FS\:DELAWARE-16 ?DS-32)
                                                           (SLP::COINCIDES-RELATION ?DS-31 ?DS-32 EQUALS)))
                                                 (:meaning . ((ANSWER ?C ?A ?D)
                                                              (LEN ?D ?B ?A)
                                                              (CONST ?D ?B ?E)
                                                              (RIVERID ?E ?F)
                                                              (DELAWARE ?F)
                                                              (RIVER ?D ?B)))))

(defparameter *how-long-is-the-missouri-river* '((:form . ((SLP::RIGHT-HAND-ARTICULATION ?PALM-UP-17 PALM-UP)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?RIVIERE.K-33 RIVIERE.K)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?PT-17 PT)
                                                           (SLP::LOCATION ?PT-17 MIDDLE)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?FS\:MISSOURI-1 FS\:MISSOURI)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?DS-33 DS)
                                                           (SLP::LOCATION ?DS-33 MIDDLE)
                                                           (SLP::HANDSHAPE ?DS-33 1)
                                                           (SLP::ORIENTATION ?DS-33 DOWN-OUT)
                                                           (SLP::MOVEMENT ?DS-33 IN-OUT)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?COMBIEN-17 COMBIEN)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?KILOMETRE-17 KILOMETRE)
                                                           (SLP::LEFT-HAND-ARTICULATION ?RIVIERE.K-34 RIVIERE.K)
                                                           (SLP::LEFT-HAND-ARTICULATION ?DS-34 DS)
                                                           (SLP::LOCATION ?DS-34 MIDDLE)
                                                           (SLP::HANDSHAPE ?DS-34 1)
                                                           (SLP::ORIENTATION ?DS-34 RIGHT-OUT)
                                                           (MEETS ?PALM-UP-17 ?RIVIERE.K-33)
                                                           (MEETS ?RIVIERE.K-33 ?PT-17)
                                                           (MEETS ?PT-17 ?FS\:MISSOURI-1)
                                                           (MEETS ?FS\:MISSOURI-1 ?DS-33)
                                                           (MEETS ?DS-33 ?COMBIEN-17)
                                                           (MEETS ?COMBIEN-17 ?KILOMETRE-17)
                                                           (MEETS ?PALM-UP-17 ?RIVIERE.K-34)
                                                           (SLP::COINCIDES-RELATION ?RIVIERE.K-33 ?RIVIERE.K-34 EQUALS)
                                                           (SLP::MEETS ?FS\:MISSOURI-1 ?DS-34)
                                                           (SLP::COINCIDES-RELATION ?DS-33 ?DS-34 EQUALS)))
                                                 (:meaning . ((ANSWER ?C ?A ?D)
                                                              (LEN ?D ?B ?A)
                                                              (CONST ?D ?B ?E)
                                                              (RIVERID ?E ?F)
                                                              (MISSOURI ?F)
                                                              (RIVER ?D ?B)))))

; First learn a holophrastic construction for one of the observations:

;(defparameter *how-long-is-the-delaware-river-holophrastic-cxn* (induce-cxns *how-long-is-the-delaware-river* nil :cxn-inventory *fcg-constructions*))



; Then use induce-cxns to learn a slot-cxn and a filler construction by comparing the holophrastic-cxn with a new observation. (for the moment really slow)

;(induce-cxns *how-long-is-the-missouri-river* *how-long-is-the-delaware-river-holophrastic-cxn*)


;(comprehend (cdr (assoc :form *how-long-is-the-missouri-river*)))



; Some tests with anti-unifying observations:
#|
(time (anti-unify-predicate-network '((SLP::RIGHT-HAND-ARTICULATION ?PALM-UP-17 PALM-UP)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?RIVIERE.K-33 RIVIERE.K)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?PT-17 PT)
                                                           (SLP::LOCATION ?PT-17 MIDDLE)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?FS\:MISSOURI-1 FS\:MISSOURI)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?DS-33 DS)
                                                           (SLP::LOCATION ?DS-33 MIDDLE)
                                                           (SLP::HANDSHAPE ?DS-33 1)
                                                           (SLP::ORIENTATION ?DS-33 DOWN-OUT)
                                                           (SLP::MOVEMENT ?DS-33 IN-OUT)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?COMBIEN-17 COMBIEN)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?KILOMETRE-17 KILOMETRE)
                                                           (SLP::LEFT-HAND-ARTICULATION ?RIVIERE.K-34 RIVIERE.K)
                                                           (SLP::LEFT-HAND-ARTICULATION ?DS-34 DS)
                                                           (SLP::LOCATION ?DS-34 MIDDLE)
                                                           (SLP::HANDSHAPE ?DS-34 1)
                                                           (SLP::ORIENTATION ?DS-34 RIGHT-OUT)
                                                           (MEETS ?PALM-UP-17 ?RIVIERE.K-33)
                                                           (MEETS ?RIVIERE.K-33 ?PT-17)
                                                           (MEETS ?PT-17 ?FS\:MISSOURI-1)
                                                           (MEETS ?FS\:MISSOURI-1 ?DS-33)
                                                           (MEETS ?DS-33 ?COMBIEN-17)
                                                           (MEETS ?COMBIEN-17 ?KILOMETRE-17)
                                                           (MEETS ?PALM-UP-17 ?RIVIERE.K-34)
                                                           (SLP::COINCIDES-RELATION ?RIVIERE.K-33 ?RIVIERE.K-34 EQUALS)
                                                           (SLP::MEETS ?FS\:MISSOURI-1 ?DS-34)
                                                           (SLP::COINCIDES-RELATION ?DS-33 ?DS-34 EQUALS))
                              '((SLP::RIGHT-HAND-ARTICULATION ?PALM-UP-16 PALM-UP)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?RIVIERE.K-31 RIVIERE.K)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?PT-16 PT)
                                                           (SLP::LOCATION ?PT-16 MIDDLE)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?FS\:DELAWARE-16 FS\:DELAWARE)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?DS-31 DS)
                                                           (SLP::LOCATION ?DS-31 MIDDLE)
                                                           (SLP::HANDSHAPE ?DS-31 1)
                                                           (SLP::ORIENTATION ?DS-31 DOWN-OUT)
                                                           (SLP::MOVEMENT ?DS-31 IN-OUT)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?COMBIEN-16 COMBIEN)
                                                           (SLP::RIGHT-HAND-ARTICULATION ?KILOMETRE-16 KILOMETRE)
                                                           (SLP::LEFT-HAND-ARTICULATION ?RIVIERE.K-32 RIVIERE.K)
                                                           (SLP::LEFT-HAND-ARTICULATION ?DS-32 DS)
                                                           (SLP::LOCATION ?DS-32 MIDDLE)
                                                           (SLP::HANDSHAPE ?DS-32 1)
                                                           (SLP::ORIENTATION ?DS-32 RIGHT-OUT)
                                                           (MEETS ?PALM-UP-16 ?RIVIERE.K-31)
                                                           (MEETS ?RIVIERE.K-31 ?PT-16)
                                                           (MEETS ?PT-16 ?FS\:DELAWARE-16)
                                                           (MEETS ?FS\:DELAWARE-16 ?DS-31)
                                                           (MEETS ?DS-31 ?COMBIEN-16)
                                                           (MEETS ?COMBIEN-16 ?KILOMETRE-16)
                                                           (MEETS ?PALM-UP-16 ?RIVIERE.K-32)
                                                           (SLP::COINCIDES-RELATION ?RIVIERE.K-31 ?RIVIERE.K-32 EQUALS)
                                                           (SLP::MEETS ?FS\:DELAWARE-16 ?DS-32)
                                                           (SLP::COINCIDES-RELATION ?DS-31 ?DS-32 EQUALS))))

(equivalent-irl-programs? '((right-hand-articulation ?r-50646 kilometre)
                            (right-hand-articulation ?s-50646 combien)
                            (right-hand-articulation ?t-50646 palm-up)
                            (meets ?s-50646 ?r-50646)
                            (left-hand-articulation ?u-50646 riviere.k)
                            (right-hand-articulation ?v-50646 pt)
                            (meets ?t-50646 ?u-50646)
                            (right-hand-articulation ?w-50646 riviere.k)
                            (meets ?t-50646 ?w-50646)
                            (meets ?v-50646 ?x-50646)
                            (location ?v-50646 middle)
                            (orientation ?y-50646 right-out)
                            (coincides-relation ?w-50646 ?u-50646 equals)
                            (meets ?w-50646 ?v-50646)
                            (left-hand-articulation ?y-50646 ds)
                            (handshape ?y-50646 1)
                            (meets ?x-50646 ?y-50646)
                            (location ?y-50646 middle)
                            (movement ?z-50646 in-out)
                            (orientation ?z-50646 down-out)
                            (right-hand-articulation ?z-50646 ds)
                            (handshape ?z-50646 1)
                            (meets ?z-50646 ?s-50646)
                            (meets ?x-50646 ?z-50646)
                            (location ?z-50646 middle)
                            (coincides-relation ?z-50646 ?y-50646 equals))
                          '((RIGHT-HAND-ARTICULATION ?W-943754 GEOQUERY-LSFB::PALM-UP)
                            (RIGHT-HAND-ARTICULATION ?X-943777 GEOQUERY-LSFB::RIVIERE.K)
                            (RIGHT-HAND-ARTICULATION ?Y-943755 GEOQUERY-LSFB::PT)
                            (LOCATION ?Y-943755 GEOQUERY-LSFB::MIDDLE)
                            (RIGHT-HAND-ARTICULATION ?Z-944010 GEOQUERY-LSFB::DS)
                            (LOCATION ?Z-944010 GEOQUERY-LSFB::MIDDLE)
                            (HANDSHAPE ?Z-944010 1)
                            (UTILS:ORIENTATION ?Z-944010 GEOQUERY-LSFB::DOWN-OUT)
                            (MOVEMENT ?Z-944010 GEOQUERY-LSFB::IN-OUT)
                            (RIGHT-HAND-ARTICULATION ?A-944769 GEOQUERY-LSFB::COMBIEN)
                            (RIGHT-HAND-ARTICULATION ?B-944321 GEOQUERY-LSFB::KILOMETRE)
                            (LEFT-HAND-ARTICULATION ?C-944193 GEOQUERY-LSFB::RIVIERE.K)
                            (LEFT-HAND-ARTICULATION ?D-944449 GEOQUERY-LSFB::DS)
                            (LOCATION ?D-944449 GEOQUERY-LSFB::MIDDLE)
                            (HANDSHAPE ?D-944449 1)
                            (UTILS:ORIENTATION ?D-944449 GEOQUERY-LSFB::RIGHT-OUT)
                            (MEETS ?W-943754 ?X-943777)
                            (MEETS ?X-943777 ?Y-943755)
                            (MEETS ?Y-943755 ?E-944001)
                            (MEETS ?E-944001 ?Z-944010)
                            (MEETS ?Z-944010 ?A-944769)
                            (MEETS ?A-944769 ?B-944321)
                            (MEETS ?W-943754 ?C-944193)
                            (COINCIDES-RELATION ?X-943777 ?C-944193 GEOQUERY-LSFB::EQUALS)
                            (MEETS ?E-944001 ?D-944449)
                            (COINCIDES-RELATION ?Z-944010 ?D-944449 GEOQUERY-LSFB::EQUALS)))

(print-ann(anti-unify-predicate-network '((RIGHT-HAND-ARTICULATION ?DANS-1 DANS)
                                      (RIGHT-HAND-ARTICULATION ?PT-18 PT)
                                      (LOCATION ?PT-18 LEFT)
                                      (RIGHT-HAND-ARTICULATION ?FS\:VIRGINIE-1 FS\:VIRGINIE)
                                      (RIGHT-HAND-ARTICULATION ?IL-Y-A-1 IL-Y-A)
                                      (RIGHT-HAND-ARTICULATION ?DANS-2 DANS)
                                      (RIGHT-HAND-ARTICULATION ?RIVIERE.K-35 RIVIERE.K)
                                      (RIGHT-HAND-ARTICULATION ?PT-19 PT)
                                      (LOCATION ?PT-19 LEFT)
                                      (RIGHT-HAND-ARTICULATION ?QUOI-1 QUOI)
                                      (RIGHT-HAND-ARTICULATION ?ME-DIRE-1 ME-DIRE)
                                      (RIGHT-HAND-ARTICULATION ?NOM.1-1 NOM.1)
                                      (RIGHT-HAND-ARTICULATION ?QUOI-2 QUOI)
                                      (LEFT-HAND-ARTICULATION ?DANS-3 DANS)
                                      (LEFT-HAND-ARTICULATION ?DANS-4 DANS)
                                      (LEFT-HAND-ARTICULATION ?RIVIERE.K-36 RIVIERE.K)
                                      (MEETS ?DANS-1 ?PT-18)
                                      (MEETS ?PT-18 ?FS\:VIRGINIE-1)
                                      (MEETS ?FS\:VIRGINIE-1 ?IL-Y-A-1)
                                      (MEETS ?IL-Y-A-1 ?DANS-2)
                                      (MEETS ?DANS-2 ?RIVIERE.K-35)
                                      (MEETS ?RIVIERE.K-35 ?PT-19)
                                      (MEETS ?PT-19 ?QUOI-1)
                                      (MEETS ?QUOI-1 ?ME-DIRE-1)
                                      (MEETS ?ME-DIRE-1 ?NOM.1-1)
                                      (MEETS ?NOM.1-1 ?QUOI-2)
                                      (COINCIDES-RELATION ?DANS-1 ?DANS-3 EQUALS)
                                      (MEETS ?IL-Y-A-1 ?DANS-4)
                                      (COINCIDES-RELATION ?DANS-2 ?DANS-4 EQUALS)
                                      (MEETS ?DANS-2 ?RIVIERE.K-36)
                                      (COINCIDES-RELATION ?RIVIERE.K-35 ?RIVIERE.K-36 EQUALS))
                                    '((RIGHT-HAND-ARTICULATION ?DANS-5 DANS)
                                      (RIGHT-HAND-ARTICULATION ?PT-20 PT)
                                      (LOCATION ?PT-20 LEFT)
                                      (HANDSHAPE ?PT-20 5)
                                      (ORIENTATION ?PT-20 DOWN-UP)
                                      (MOVEMENT ?PT-20 CIRCLE)
                                      (RIGHT-HAND-ARTICULATION ?FS\:VIRGINIE-2 FS\:VIRGINIE)
                                      (RIGHT-HAND-ARTICULATION ?DANS-6 DANS)
                                      (RIGHT-HAND-ARTICULATION ?IL-Y-A-2 IL-Y-A)
                                      (RIGHT-HAND-ARTICULATION ?VILLE-1 VILLE)
                                      (RIGHT-HAND-ARTICULATION ?QUOI-3 QUOI)
                                      (RIGHT-HAND-ARTICULATION ?PALM-UP-18 PALM-UP)
                                      (RIGHT-HAND-ARTICULATION ?ME-DIRE-2 ME-DIRE)
                                      (MODIFICATION ?ME-DIRE-2 REDUPLICATED)
                                      (LEFT-HAND-ARTICULATION ?DANS-7 DANS)
                                      (LEFT-HAND-ARTICULATION ?DS-35 DS)
                                      (LOCATION ?DS-35 LEFT)
                                      (HANDSHAPE ?DS-35 7)
                                      (ORIENTATION ?DS-35 DOWN-UP)
                                      (LEFT-HAND-ARTICULATION ?DANS-8 DANS)
                                      (LEFT-HAND-ARTICULATION ?VILLE-2 VILLE)
                                      (LEFT-HAND-ARTICULATION ?ME-DIRE-3 ME-DIRE)
                                      (MODIFICATION ?ME-DIRE-3 REDUPLICATED)
                                      (MEETS ?DANS-5 ?PT-20)
                                      (MEETS ?PT-20 ?FS\:VIRGINIE-2)
                                      (MEETS ?FS\:VIRGINIE-2 ?DANS-6)
                                      (MEETS ?DANS-6 ?IL-Y-A-2)
                                      (MEETS ?IL-Y-A-2 ?VILLE-1)
                                      (MEETS ?VILLE-1 ?QUOI-3)
                                      (MEETS ?QUOI-3 ?PALM-UP-18)
                                      (MEETS ?PALM-UP-18 ?ME-DIRE-2)
                                      (COINCIDES-RELATION ?DANS-5 ?DANS-7 EQUALS)
                                      (MEETS ?DANS-5 ?DS-35)
                                      (COINCIDES-RELATION ?PT-20 ?DS-35 EQUALS)
                                      (MEETS ?FS\:VIRGINIE-2 ?DANS-8)
                                      (COINCIDES-RELATION ?DANS-6 ?DANS-8 EQUALS)
                                      (MEETS ?IL-Y-A-2 ?VILLE-2)
                                      (COINCIDES-RELATION ?VILLE-1 ?VILLE-2 EQUALS)
                                      (MEETS ?PALM-UP-18 ?ME-DIRE-3)
                                      (COINCIDES-RELATION ?ME-DIRE-2 ?ME-DIRE-3 EQUALS))))

|#


